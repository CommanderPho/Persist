name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Get the release version
      id: release_version
      run: echo "::set-output name=version::${GITHUB_REF/refs\/tags\//}"

    - name: Get release description
      run: |
        description="$(git tag -ln --format=$'%(contents:subject)\n\n%(contents:body)' ${{ steps.release_version.outputs.version }})""
        # Fix set-output for multiline strings: https://github.community/t/set-output-truncates-multiline-strings/16852
        description="${description//'%'/'%25'}"
        description="${description//$'\n'/'%0A'}"
        description="${description//$'\r'/'%0D'}"
        echo "::set-output name=description::$description"
      id: release_description

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_version.outputs.version }}
        release_name: Release ${{ steps.release_version.outputs.version }}
        body: ${{ steps.release_description.outputs.description }}
        prerelease: true

  build_docs:
    name: Build Docs
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        xcode: ["11.4"]

    steps:
    - uses: actions/checkout@v2

    - name: Select Xcode ${{ matrix.xcode }}
      run: sudo xcode-select --switch /Applications/Xcode_${{ matrix.xcode }}.app

    - name: Cache SwiftPM
      uses: actions/cache@v1
      with:
        path: CIDependencies/.build
        key: ${{ runner.os }}-xcode_${{ matrix.xcode }}-swiftpm-ci-deps-${{ github.workspace }}-${{ hashFiles('CIDependencies/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-xcode_${{ matrix.xcode }}-swiftpm-ci-deps-${{ github.workspace }}

    - name: Build docs
      run: swift run --configuration release --package-path ./CIDependencies/ sourcedocs generate --spm-module Persist

    - name: Upload Docs
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./Documentation/Reference/
